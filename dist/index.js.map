{"version":3,"sources":["../src/schemas.ts","../src/auth.ts","../src/capture.ts","../src/compare.ts","../src/session.ts","../src/report.ts","../src/index.ts"],"names":["z","userInfo","join","readFile","stat","randomBytes","writeFile","unlink","chromium","mkdir","dirname","PNG","pixelmatch","nanoid","readdir","rm"],"mappings":"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","file":"index.js","sourcesContent":["import { z } from 'zod';\n\n/**\n * Viewport configuration for screenshot capture\n * Supports predefined names or custom dimensions\n */\nexport const ViewportSchema = z.object({\n  name: z.string().min(1).max(50),\n  width: z.number().min(320).max(3840),\n  height: z.number().min(480).max(2160),\n});\n\n/**\n * Predefined viewport configurations\n */\nexport const VIEWPORTS = {\n  desktop: { name: 'desktop', width: 1920, height: 1080 },\n  'desktop-lg': { name: 'desktop-lg', width: 2560, height: 1440 },\n  'desktop-sm': { name: 'desktop-sm', width: 1440, height: 900 },\n  laptop: { name: 'laptop', width: 1366, height: 768 },\n  tablet: { name: 'tablet', width: 768, height: 1024 },\n  'tablet-landscape': { name: 'tablet-landscape', width: 1024, height: 768 },\n  mobile: { name: 'mobile', width: 375, height: 667 },\n  'mobile-lg': { name: 'mobile-lg', width: 414, height: 896 },\n  'iphone-14': { name: 'iphone-14', width: 390, height: 844 },\n  'iphone-14-pro-max': { name: 'iphone-14-pro-max', width: 430, height: 932 },\n} as const;\n\n/**\n * Main configuration for InterfaceBuiltRight\n */\nexport const ConfigSchema = z.object({\n  baseUrl: z.string().url('Must be a valid URL'),\n  outputDir: z.string().default('./.ibr'),\n  viewport: ViewportSchema.default(VIEWPORTS.desktop),\n  viewports: z.array(ViewportSchema).optional(), // Multi-viewport support\n  threshold: z.number().min(0).max(100).default(1.0),\n  fullPage: z.boolean().default(true),\n  waitForNetworkIdle: z.boolean().default(true),\n  timeout: z.number().min(1000).max(120000).default(30000),\n});\n\n/**\n * Session query options\n */\nexport const SessionQuerySchema = z.object({\n  route: z.string().optional(),\n  url: z.string().optional(),\n  status: z.enum(['baseline', 'compared', 'pending']).optional(),\n  name: z.string().optional(),\n  createdAfter: z.date().optional(),\n  createdBefore: z.date().optional(),\n  viewport: z.string().optional(),\n  limit: z.number().min(1).max(100).default(50),\n});\n\n/**\n * Comparison result from pixelmatch\n */\nexport const ComparisonResultSchema = z.object({\n  match: z.boolean(),\n  diffPercent: z.number(),\n  diffPixels: z.number(),\n  totalPixels: z.number(),\n  threshold: z.number(),\n});\n\n/**\n * Changed region detected in comparison\n */\nexport const ChangedRegionSchema = z.object({\n  location: z.enum(['top', 'bottom', 'left', 'right', 'center', 'full']),\n  bounds: z.object({\n    x: z.number(),\n    y: z.number(),\n    width: z.number(),\n    height: z.number(),\n  }),\n  description: z.string(),\n  severity: z.enum(['expected', 'unexpected', 'critical']),\n});\n\n/**\n * Analysis verdict types\n */\nexport const VerdictSchema = z.enum([\n  'MATCH',\n  'EXPECTED_CHANGE',\n  'UNEXPECTED_CHANGE',\n  'LAYOUT_BROKEN',\n]);\n\n/**\n * Analysis result\n */\nexport const AnalysisSchema = z.object({\n  verdict: VerdictSchema,\n  summary: z.string(),\n  changedRegions: z.array(ChangedRegionSchema),\n  unexpectedChanges: z.array(ChangedRegionSchema),\n  recommendation: z.string().nullable(),\n});\n\n/**\n * Session status\n */\nexport const SessionStatusSchema = z.enum(['baseline', 'compared', 'pending']);\n\n/**\n * Visual session\n */\nexport const SessionSchema = z.object({\n  id: z.string(),\n  name: z.string(),\n  url: z.string().url(),\n  viewport: ViewportSchema,\n  status: SessionStatusSchema,\n  createdAt: z.string().datetime(),\n  updatedAt: z.string().datetime(),\n  comparison: ComparisonResultSchema.optional(),\n  analysis: AnalysisSchema.optional(),\n});\n\n/**\n * Full comparison report\n */\nexport const ComparisonReportSchema = z.object({\n  sessionId: z.string(),\n  sessionName: z.string(),\n  url: z.string(),\n  timestamp: z.string().datetime(),\n  viewport: ViewportSchema,\n  comparison: ComparisonResultSchema,\n  analysis: AnalysisSchema,\n  files: z.object({\n    baseline: z.string(),\n    current: z.string(),\n    diff: z.string(),\n  }),\n  webViewUrl: z.string().optional(),\n});\n\n// Type exports - auto-generated from schemas\nexport type Viewport = z.infer<typeof ViewportSchema>;\nexport type Config = z.infer<typeof ConfigSchema>;\nexport type SessionQuery = z.infer<typeof SessionQuerySchema>;\nexport type ComparisonResult = z.infer<typeof ComparisonResultSchema>;\nexport type ChangedRegion = z.infer<typeof ChangedRegionSchema>;\nexport type Verdict = z.infer<typeof VerdictSchema>;\nexport type Analysis = z.infer<typeof AnalysisSchema>;\nexport type SessionStatus = z.infer<typeof SessionStatusSchema>;\nexport type Session = z.infer<typeof SessionSchema>;\nexport type ComparisonReport = z.infer<typeof ComparisonReportSchema>;\n","import { chromium } from 'playwright';\nimport { mkdir, access, readFile, writeFile, unlink, chmod, stat } from 'fs/promises';\nimport { join, dirname, resolve } from 'path';\nimport { existsSync, readFileSync } from 'fs';\nimport { userInfo, homedir } from 'os';\nimport { createHash, randomBytes } from 'crypto';\nimport type { LoginOptions } from './types.js';\n\nconst AUTH_STATE_FILE = 'auth.json';\n\n/**\n * Auth state with metadata for security\n */\ninterface StoredAuthState {\n  state: object; // Playwright storage state\n  metadata: {\n    createdAt: number;\n    expiresAt: number;\n    username: string;\n    projectPath: string;\n  };\n}\n\n/**\n * Check if running in a CI/CD or deployed environment\n * Auth operations should be blocked in these environments\n */\nexport function isDeployedEnvironment(): boolean {\n  return !!(\n    process.env.VERCEL ||\n    process.env.NETLIFY ||\n    process.env.CI ||\n    process.env.GITHUB_ACTIONS ||\n    process.env.GITLAB_CI ||\n    process.env.CIRCLECI ||\n    process.env.JENKINS_URL ||\n    process.env.TRAVIS ||\n    process.env.HEROKU ||\n    process.env.AWS_LAMBDA_FUNCTION_NAME ||\n    process.env.AZURE_FUNCTIONS_ENVIRONMENT\n  );\n}\n\n/**\n * Get the path to the auth state file\n * Uses per-user isolation to prevent credential sharing\n */\nexport function getAuthStatePath(outputDir: string): string {\n  const username = userInfo().username;\n  // Include username in filename for user isolation\n  return join(outputDir, `auth.${username}.json`);\n}\n\n/**\n * Get a secure auth path in user's home directory (alternative)\n * This keeps auth completely outside the project directory\n */\nexport function getSecureAuthPath(projectPath: string): string {\n  const username = userInfo().username;\n  // Hash project path to create unique identifier\n  const projectHash = createHash('sha256')\n    .update(resolve(projectPath))\n    .digest('hex')\n    .substring(0, 16);\n\n  return join(\n    homedir(),\n    '.config',\n    'ibr',\n    'auth',\n    `${projectHash}.${username}.json`\n  );\n}\n\n/**\n * Check if .gitignore properly excludes .ibr directory\n */\nfunction validateGitignore(projectDir: string): void {\n  const gitignorePath = join(projectDir, '.gitignore');\n\n  if (existsSync(gitignorePath)) {\n    const gitignore = readFileSync(gitignorePath, 'utf-8');\n    const lines = gitignore.split('\\n').map(l => l.trim());\n\n    const hasIbrIgnore = lines.some(line =>\n      line === '.ibr/' ||\n      line === '.ibr' ||\n      line === '**/.ibr/' ||\n      line === '**/.ibr'\n    );\n\n    if (!hasIbrIgnore) {\n      console.warn('\\n‚ö†Ô∏è  WARNING: .ibr/ is not in .gitignore!');\n      console.warn('   Add \".ibr/\" to .gitignore to prevent credential leaks.\\n');\n    }\n  } else {\n    console.warn('\\n‚ö†Ô∏è  No .gitignore found. Create one with \".ibr/\" entry.\\n');\n  }\n}\n\n/**\n * Check if auth state exists\n */\nexport async function hasAuthState(outputDir: string): Promise<boolean> {\n  try {\n    await access(getAuthStatePath(outputDir));\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Load auth state if it exists and is valid\n */\nexport async function loadAuthState(outputDir: string): Promise<object | null> {\n  // Block in deployed environments\n  if (isDeployedEnvironment()) {\n    console.warn('‚ö†Ô∏è  Deployed environment detected. Auth state not available.');\n    return null;\n  }\n\n  try {\n    const authPath = getAuthStatePath(outputDir);\n    const content = await readFile(authPath, 'utf-8');\n    const stored: StoredAuthState = JSON.parse(content);\n\n    // Validate metadata exists\n    if (!stored.metadata) {\n      console.warn('‚ö†Ô∏è  Legacy auth format detected. Please re-authenticate with `ibr login`.');\n      return null;\n    }\n\n    // Check user matches\n    const currentUser = userInfo().username;\n    if (stored.metadata.username !== currentUser) {\n      console.warn(`‚ö†Ô∏è  Auth state belongs to different user (${stored.metadata.username}).`);\n      return null;\n    }\n\n    // Check expiration\n    if (Date.now() > stored.metadata.expiresAt) {\n      console.warn('‚ö†Ô∏è  Auth state expired. Please re-authenticate with `ibr login`.');\n      await clearAuthState(outputDir);\n      return null;\n    }\n\n    // Warn if auth is getting old (> 24 hours)\n    const ageHours = (Date.now() - stored.metadata.createdAt) / (1000 * 60 * 60);\n    if (ageHours > 24) {\n      console.warn(`‚ö†Ô∏è  Auth state is ${Math.floor(ageHours)} hours old. Consider re-authenticating.`);\n    }\n\n    return stored.state;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Open a browser for manual login and save the state\n *\n * This opens a visible browser window where the user can:\n * 1. Navigate to login page\n * 2. Enter credentials\n * 3. Complete any 2FA or other auth steps\n *\n * When done, close the browser or press Ctrl+C to save the state.\n */\nexport async function performLogin(options: LoginOptions): Promise<string> {\n  const { url, outputDir, timeout = 300000 } = options; // 5 min default timeout\n\n  // Block in deployed environments\n  if (isDeployedEnvironment()) {\n    throw new Error(\n      'Authentication cannot be performed in deployed environments.\\n' +\n      'Run `ibr login` locally on your development machine.'\n    );\n  }\n\n  // Validate .gitignore before storing credentials\n  validateGitignore(process.cwd());\n\n  // Ensure output directory exists with restricted permissions\n  await mkdir(outputDir, { recursive: true, mode: 0o700 }); // rwx------\n\n  // Fix permissions on existing directory\n  try {\n    await chmod(outputDir, 0o700);\n  } catch {\n    // Ignore if chmod fails (e.g., on Windows)\n  }\n\n  const authStatePath = getAuthStatePath(outputDir);\n  const currentUser = userInfo().username;\n\n  console.log('\\nüîê Opening browser for login...');\n  console.log(`   User: ${currentUser}`);\n  console.log('   Navigate to your login page and complete authentication.');\n  console.log('   When finished, close the browser window to save your session.\\n');\n\n  const browser = await chromium.launch({\n    headless: false, // Visible browser for manual login\n  });\n\n  const context = await browser.newContext({\n    viewport: { width: 1280, height: 800 },\n  });\n\n  const page = await context.newPage();\n\n  try {\n    // Navigate to the provided URL\n    await page.goto(url, {\n      waitUntil: 'domcontentloaded',\n      timeout: 30000,\n    });\n\n    // Wait for browser to close (user manually closes it after login)\n    // or timeout after the specified duration\n    await Promise.race([\n      new Promise<void>((resolve) => {\n        browser.on('disconnected', () => resolve());\n      }),\n      new Promise<void>((_, reject) => {\n        setTimeout(() => reject(new Error('Login timeout exceeded')), timeout);\n      }),\n    ]);\n\n  } catch (error) {\n    // If browser is still open, save the state before closing\n    if (browser.isConnected()) {\n      await saveAuthState(context, authStatePath, outputDir);\n      await browser.close();\n    }\n\n    // Check if it was a timeout or browser close\n    if (error instanceof Error && error.message.includes('timeout')) {\n      throw error;\n    }\n  }\n\n  // If we get here without the browser being disconnected, save state\n  if (browser.isConnected()) {\n    await saveAuthState(context, authStatePath, outputDir);\n    await browser.close();\n  } else {\n    // Browser was closed by user - try to reconnect to save state\n    console.log('\\n‚ö†Ô∏è  Browser was closed. Attempting to save any captured state...');\n\n    // Create a new context just to save an empty state as fallback\n    const newBrowser = await chromium.launch({ headless: true });\n    const newContext = await newBrowser.newContext();\n\n    // Try to use any cookies from the page\n    try {\n      await newContext.addCookies(await context.cookies());\n    } catch {\n      // Context might be closed\n    }\n\n    await saveAuthState(newContext, authStatePath, outputDir);\n    await newBrowser.close();\n  }\n\n  console.log(`\\n‚úÖ Auth state saved for user: ${currentUser}`);\n  console.log(`   Location: ${authStatePath}`);\n  console.log('   Expires: 7 days from now');\n  console.log('   Future captures will use this authentication.\\n');\n\n  return authStatePath;\n}\n\n/**\n * Save auth state with metadata and secure permissions\n */\nasync function saveAuthState(\n  context: Awaited<ReturnType<typeof chromium.launch>>['contexts'][0],\n  authStatePath: string,\n  outputDir: string\n): Promise<void> {\n  const state = await context.storageState();\n  const currentUser = userInfo().username;\n\n  const storedState: StoredAuthState = {\n    state,\n    metadata: {\n      createdAt: Date.now(),\n      expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000), // 7 days\n      username: currentUser,\n      projectPath: resolve(process.cwd()),\n    }\n  };\n\n  // Write with restricted permissions (owner read/write only)\n  await writeFile(\n    authStatePath,\n    JSON.stringify(storedState, null, 2),\n    { mode: 0o600 } // rw-------\n  );\n\n  // Ensure permissions are correct (in case file existed)\n  try {\n    await chmod(authStatePath, 0o600);\n  } catch {\n    // Ignore if chmod fails (e.g., on Windows)\n  }\n}\n\n/**\n * Clear saved auth state with secure deletion\n */\nexport async function clearAuthState(outputDir: string): Promise<void> {\n  const authPath = getAuthStatePath(outputDir);\n\n  try {\n    // Get file stats for size\n    const stats = await stat(authPath);\n\n    // Overwrite with random data before deletion (secure delete)\n    const randomData = randomBytes(stats.size);\n    await writeFile(authPath, randomData, { mode: 0o600 });\n\n    // Now delete the file\n    await unlink(authPath);\n\n    console.log('‚úÖ Auth state securely cleared');\n  } catch {\n    console.log('‚ÑπÔ∏è  No auth state to clear');\n  }\n}\n\n/**\n * Get auth state info without loading the full state\n */\nexport async function getAuthStateInfo(outputDir: string): Promise<{\n  exists: boolean;\n  username?: string;\n  createdAt?: Date;\n  expiresAt?: Date;\n  expired?: boolean;\n} | null> {\n  try {\n    const authPath = getAuthStatePath(outputDir);\n    const content = await readFile(authPath, 'utf-8');\n    const stored: StoredAuthState = JSON.parse(content);\n\n    if (!stored.metadata) {\n      return { exists: true };\n    }\n\n    return {\n      exists: true,\n      username: stored.metadata.username,\n      createdAt: new Date(stored.metadata.createdAt),\n      expiresAt: new Date(stored.metadata.expiresAt),\n      expired: Date.now() > stored.metadata.expiresAt,\n    };\n  } catch {\n    return null;\n  }\n}\n","import { chromium, type Browser } from 'playwright';\nimport { mkdir } from 'fs/promises';\nimport { dirname } from 'path';\nimport { VIEWPORTS, type Viewport } from './schemas.js';\nimport type { CaptureOptions } from './types.js';\nimport { loadAuthState, isDeployedEnvironment } from './auth.js';\n\n// Playwright's storage state type\ntype StorageState = {\n  cookies: Array<{\n    name: string;\n    value: string;\n    domain: string;\n    path: string;\n    expires: number;\n    httpOnly: boolean;\n    secure: boolean;\n    sameSite: 'Strict' | 'Lax' | 'None';\n  }>;\n  origins: Array<{\n    origin: string;\n    localStorage: Array<{ name: string; value: string }>;\n  }>;\n};\n\nlet browser: Browser | null = null;\n\n/**\n * Get or create a browser instance\n */\nasync function getBrowser(): Promise<Browser> {\n  if (!browser) {\n    browser = await chromium.launch({\n      headless: true,\n    });\n  }\n  return browser;\n}\n\n/**\n * Close the browser instance\n */\nexport async function closeBrowser(): Promise<void> {\n  if (browser) {\n    await browser.close();\n    browser = null;\n  }\n}\n\n/**\n * Capture a screenshot of a URL\n */\nexport async function captureScreenshot(\n  options: CaptureOptions & { outputDir?: string }\n): Promise<string> {\n  const {\n    url,\n    outputPath,\n    viewport = VIEWPORTS.desktop,\n    fullPage = true,\n    waitForNetworkIdle = true,\n    timeout = 30000,\n    outputDir,\n  } = options;\n\n  // Ensure output directory exists\n  await mkdir(dirname(outputPath), { recursive: true });\n\n  // Load auth state if available (handles validation, expiration, user isolation)\n  let storageState: StorageState | undefined;\n  if (outputDir && !isDeployedEnvironment()) {\n    const authState = await loadAuthState(outputDir);\n    if (authState) {\n      storageState = authState as StorageState;\n      console.log('üîê Using saved authentication state');\n    }\n  }\n\n  const browserInstance = await getBrowser();\n  const context = await browserInstance.newContext({\n    viewport: {\n      width: viewport.width,\n      height: viewport.height,\n    },\n    // Disable animations for consistent screenshots\n    reducedMotion: 'reduce',\n    // Load auth state if available (Playwright accepts object or file path)\n    ...(storageState ? { storageState } : {}),\n  });\n\n  const page = await context.newPage();\n\n  try {\n    // Navigate to URL\n    await page.goto(url, {\n      waitUntil: waitForNetworkIdle ? 'networkidle' : 'load',\n      timeout,\n    });\n\n    // Wait for any remaining animations to settle\n    await page.waitForTimeout(500);\n\n    // Disable CSS animations and transitions\n    await page.addStyleTag({\n      content: `\n        *, *::before, *::after {\n          animation-duration: 0s !important;\n          animation-delay: 0s !important;\n          transition-duration: 0s !important;\n          transition-delay: 0s !important;\n        }\n      `,\n    });\n\n    // Take screenshot\n    await page.screenshot({\n      path: outputPath,\n      fullPage,\n      type: 'png',\n    });\n\n    return outputPath;\n  } finally {\n    await context.close();\n  }\n}\n\n/**\n * Get viewport dimensions by name\n */\nexport function getViewport(name: 'desktop' | 'mobile' | 'tablet'): Viewport {\n  return VIEWPORTS[name];\n}\n\n/**\n * Capture multiple viewports\n */\nexport async function captureMultipleViewports(\n  url: string,\n  outputDir: string,\n  viewports: Array<'desktop' | 'mobile' | 'tablet'> = ['desktop'],\n  options: Omit<CaptureOptions, 'url' | 'outputPath' | 'viewport'> = {}\n): Promise<Record<string, string>> {\n  const results: Record<string, string> = {};\n\n  for (const viewportName of viewports) {\n    const viewport = getViewport(viewportName);\n    const outputPath = `${outputDir}/${viewportName}.png`;\n\n    await captureScreenshot({\n      url,\n      outputPath,\n      viewport,\n      ...options,\n    });\n\n    results[viewportName] = outputPath;\n  }\n\n  return results;\n}\n","import pixelmatch from 'pixelmatch';\nimport { PNG } from 'pngjs';\nimport { readFile, writeFile, mkdir } from 'fs/promises';\nimport { dirname } from 'path';\nimport type { CompareOptions } from './types.js';\nimport type { ComparisonResult, Analysis, ChangedRegion, Verdict } from './schemas.js';\n\n/**\n * Compare two images using pixelmatch\n */\nexport async function compareImages(options: CompareOptions): Promise<ComparisonResult> {\n  const {\n    baselinePath,\n    currentPath,\n    diffPath,\n    threshold = 0.1, // pixelmatch threshold (0-1), lower = stricter\n  } = options;\n\n  // Read images\n  const [baselineBuffer, currentBuffer] = await Promise.all([\n    readFile(baselinePath),\n    readFile(currentPath),\n  ]);\n\n  const baseline = PNG.sync.read(baselineBuffer);\n  const current = PNG.sync.read(currentBuffer);\n\n  // Ensure images have same dimensions\n  if (baseline.width !== current.width || baseline.height !== current.height) {\n    throw new Error(\n      `Image dimensions mismatch: baseline (${baseline.width}x${baseline.height}) vs current (${current.width}x${current.height})`\n    );\n  }\n\n  const { width, height } = baseline;\n  const diff = new PNG({ width, height });\n  const totalPixels = width * height;\n\n  // Run pixelmatch\n  const diffPixels = pixelmatch(\n    baseline.data,\n    current.data,\n    diff.data,\n    width,\n    height,\n    {\n      threshold,\n      includeAA: false, // Ignore anti-aliasing differences\n      alpha: 0.1,\n      diffColor: [255, 0, 0], // Red for differences\n      diffColorAlt: [0, 255, 0], // Green for anti-aliased differences\n    }\n  );\n\n  // Ensure output directory exists\n  await mkdir(dirname(diffPath), { recursive: true });\n\n  // Write diff image\n  await writeFile(diffPath, PNG.sync.write(diff));\n\n  const diffPercent = (diffPixels / totalPixels) * 100;\n\n  return {\n    match: diffPixels === 0,\n    diffPercent: Math.round(diffPercent * 100) / 100, // Round to 2 decimal places\n    diffPixels,\n    totalPixels,\n    threshold,\n  };\n}\n\n/**\n * Analyze comparison result and generate verdict\n */\nexport function analyzeComparison(\n  result: ComparisonResult,\n  thresholdPercent: number = 1.0\n): Analysis {\n  const { match, diffPercent, diffPixels } = result;\n\n  // Determine verdict\n  let verdict: Verdict;\n  let summary: string;\n  let recommendation: string | null = null;\n\n  if (match || diffPercent === 0) {\n    verdict = 'MATCH';\n    summary = 'No visual changes detected. Screenshots are identical.';\n  } else if (diffPercent <= thresholdPercent) {\n    verdict = 'EXPECTED_CHANGE';\n    summary = `Minor changes detected (${diffPercent}% difference). Changes appear intentional.`;\n  } else if (diffPercent <= 20) {\n    verdict = 'EXPECTED_CHANGE';\n    summary = `Moderate changes detected (${diffPercent}% difference, ${diffPixels.toLocaleString()} pixels). Review the diff image to verify changes are as expected.`;\n  } else if (diffPercent <= 50) {\n    verdict = 'UNEXPECTED_CHANGE';\n    summary = `Significant changes detected (${diffPercent}% difference). Some changes may be unintentional.`;\n    recommendation = 'Review the diff image carefully. Large portions of the page have changed.';\n  } else {\n    verdict = 'LAYOUT_BROKEN';\n    summary = `Major changes detected (${diffPercent}% difference). Layout may be broken or page failed to load correctly.`;\n    recommendation = 'Check for JavaScript errors, missing assets, or layout issues. The page appears significantly different from the baseline.';\n  }\n\n  // Generate changed regions (simplified - just one region for now)\n  const changedRegions: ChangedRegion[] = [];\n  const unexpectedChanges: ChangedRegion[] = [];\n\n  if (!match) {\n    const region: ChangedRegion = {\n      location: diffPercent > 50 ? 'full' : 'center',\n      bounds: { x: 0, y: 0, width: 0, height: 0 }, // Would need pixel analysis for accurate bounds\n      description: `${diffPercent}% of pixels changed`,\n      severity: verdict === 'LAYOUT_BROKEN' ? 'critical' :\n                verdict === 'UNEXPECTED_CHANGE' ? 'unexpected' : 'expected',\n    };\n\n    if (verdict === 'UNEXPECTED_CHANGE' || verdict === 'LAYOUT_BROKEN') {\n      unexpectedChanges.push(region);\n    } else {\n      changedRegions.push(region);\n    }\n  }\n\n  return {\n    verdict,\n    summary,\n    changedRegions,\n    unexpectedChanges,\n    recommendation,\n  };\n}\n\n/**\n * Get a human-readable verdict description\n */\nexport function getVerdictDescription(verdict: Verdict): string {\n  switch (verdict) {\n    case 'MATCH':\n      return 'No changes - screenshots match';\n    case 'EXPECTED_CHANGE':\n      return 'Changes detected - appear intentional';\n    case 'UNEXPECTED_CHANGE':\n      return 'Unexpected changes - review required';\n    case 'LAYOUT_BROKEN':\n      return 'Layout broken - significant issues detected';\n    default:\n      return 'Unknown verdict';\n  }\n}\n","import { nanoid } from 'nanoid';\nimport { mkdir, readFile, writeFile, readdir, rm } from 'fs/promises';\nimport { join } from 'path';\nimport { SessionSchema, SessionQuerySchema, type Session, type SessionQuery, type Viewport, type ComparisonResult, type Analysis } from './schemas.js';\nimport type { SessionPaths, CleanOptions } from './types.js';\n\nconst SESSION_PREFIX = 'sess_';\n\n/**\n * Generate a unique session ID\n */\nexport function generateSessionId(): string {\n  return `${SESSION_PREFIX}${nanoid(10)}`;\n}\n\n/**\n * Get paths for a session\n */\nexport function getSessionPaths(outputDir: string, sessionId: string): SessionPaths {\n  const root = join(outputDir, 'sessions', sessionId);\n  return {\n    root,\n    sessionJson: join(root, 'session.json'),\n    baseline: join(root, 'baseline.png'),\n    current: join(root, 'current.png'),\n    diff: join(root, 'diff.png'),\n  };\n}\n\n/**\n * Create a new session\n */\nexport async function createSession(\n  outputDir: string,\n  url: string,\n  name: string,\n  viewport: Viewport\n): Promise<Session> {\n  const sessionId = generateSessionId();\n  const paths = getSessionPaths(outputDir, sessionId);\n  const now = new Date().toISOString();\n\n  const session: Session = {\n    id: sessionId,\n    name,\n    url,\n    viewport,\n    status: 'baseline',\n    createdAt: now,\n    updatedAt: now,\n  };\n\n  // Create session directory\n  await mkdir(paths.root, { recursive: true });\n\n  // Write session file\n  await writeFile(paths.sessionJson, JSON.stringify(session, null, 2));\n\n  return session;\n}\n\n/**\n * Get a session by ID\n */\nexport async function getSession(outputDir: string, sessionId: string): Promise<Session | null> {\n  const paths = getSessionPaths(outputDir, sessionId);\n\n  try {\n    const content = await readFile(paths.sessionJson, 'utf-8');\n    const data = JSON.parse(content);\n    return SessionSchema.parse(data);\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Update a session\n */\nexport async function updateSession(\n  outputDir: string,\n  sessionId: string,\n  updates: Partial<Omit<Session, 'id' | 'createdAt'>>\n): Promise<Session> {\n  const session = await getSession(outputDir, sessionId);\n  if (!session) {\n    throw new Error(`Session not found: ${sessionId}`);\n  }\n\n  const updated: Session = {\n    ...session,\n    ...updates,\n    updatedAt: new Date().toISOString(),\n  };\n\n  const paths = getSessionPaths(outputDir, sessionId);\n  await writeFile(paths.sessionJson, JSON.stringify(updated, null, 2));\n\n  return updated;\n}\n\n/**\n * Mark session as compared with results\n */\nexport async function markSessionCompared(\n  outputDir: string,\n  sessionId: string,\n  comparison: ComparisonResult,\n  analysis: Analysis\n): Promise<Session> {\n  return updateSession(outputDir, sessionId, {\n    status: 'compared',\n    comparison,\n    analysis,\n  });\n}\n\n/**\n * List all sessions\n */\nexport async function listSessions(outputDir: string): Promise<Session[]> {\n  const sessionsDir = join(outputDir, 'sessions');\n\n  try {\n    const entries = await readdir(sessionsDir, { withFileTypes: true });\n    const sessions: Session[] = [];\n\n    for (const entry of entries) {\n      if (entry.isDirectory() && entry.name.startsWith(SESSION_PREFIX)) {\n        const session = await getSession(outputDir, entry.name);\n        if (session) {\n          sessions.push(session);\n        }\n      }\n    }\n\n    // Sort by creation date, newest first\n    return sessions.sort((a, b) =>\n      new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()\n    );\n  } catch {\n    return [];\n  }\n}\n\n/**\n * Get the most recent session\n */\nexport async function getMostRecentSession(outputDir: string): Promise<Session | null> {\n  const sessions = await listSessions(outputDir);\n  return sessions[0] || null;\n}\n\n/**\n * Delete a session\n */\nexport async function deleteSession(outputDir: string, sessionId: string): Promise<boolean> {\n  const paths = getSessionPaths(outputDir, sessionId);\n\n  try {\n    await rm(paths.root, { recursive: true, force: true });\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Parse duration string to milliseconds\n */\nfunction parseDuration(duration: string): number {\n  const match = duration.match(/^(\\d+)(d|h|m|s)$/);\n  if (!match) {\n    throw new Error(`Invalid duration format: ${duration}. Use format like '7d', '24h', '30m', '60s'`);\n  }\n\n  const value = parseInt(match[1], 10);\n  const unit = match[2];\n\n  switch (unit) {\n    case 'd': return value * 24 * 60 * 60 * 1000;\n    case 'h': return value * 60 * 60 * 1000;\n    case 'm': return value * 60 * 1000;\n    case 's': return value * 1000;\n    default: return value * 1000;\n  }\n}\n\n/**\n * Clean old sessions\n */\nexport async function cleanSessions(\n  outputDir: string,\n  options: CleanOptions = {}\n): Promise<{ deleted: string[]; kept: string[] }> {\n  const { olderThan, keepLast = 0, dryRun = false } = options;\n  const sessions = await listSessions(outputDir);\n\n  const deleted: string[] = [];\n  const kept: string[] = [];\n\n  // Sessions to keep based on keepLast\n  const keepIds = new Set(sessions.slice(0, keepLast).map(s => s.id));\n\n  // Calculate cutoff time if olderThan is specified\n  const cutoffTime = olderThan\n    ? Date.now() - parseDuration(olderThan)\n    : 0;\n\n  for (const session of sessions) {\n    const sessionTime = new Date(session.createdAt).getTime();\n    const shouldDelete = !keepIds.has(session.id) &&\n      (olderThan ? sessionTime < cutoffTime : true);\n\n    if (shouldDelete && !keepIds.has(session.id)) {\n      if (!dryRun) {\n        await deleteSession(outputDir, session.id);\n      }\n      deleted.push(session.id);\n    } else {\n      kept.push(session.id);\n    }\n  }\n\n  return { deleted, kept };\n}\n\n/**\n * Find sessions matching query criteria\n */\nexport async function findSessions(\n  outputDir: string,\n  query: Partial<SessionQuery> = {}\n): Promise<Session[]> {\n  // Validate query with defaults\n  const validatedQuery = SessionQuerySchema.parse({\n    limit: 50,\n    ...query,\n  });\n\n  const allSessions = await listSessions(outputDir);\n  let filtered = allSessions;\n\n  // Filter by route (extract path from URL)\n  if (validatedQuery.route) {\n    const routePattern = validatedQuery.route.toLowerCase();\n    filtered = filtered.filter(s => {\n      try {\n        const urlPath = new URL(s.url).pathname.toLowerCase();\n        return urlPath.includes(routePattern) || urlPath === routePattern;\n      } catch {\n        return s.url.toLowerCase().includes(routePattern);\n      }\n    });\n  }\n\n  // Filter by URL (exact or partial match)\n  if (validatedQuery.url) {\n    const urlPattern = validatedQuery.url.toLowerCase();\n    filtered = filtered.filter(s => s.url.toLowerCase().includes(urlPattern));\n  }\n\n  // Filter by status\n  if (validatedQuery.status) {\n    filtered = filtered.filter(s => s.status === validatedQuery.status);\n  }\n\n  // Filter by name\n  if (validatedQuery.name) {\n    const namePattern = validatedQuery.name.toLowerCase();\n    filtered = filtered.filter(s => s.name.toLowerCase().includes(namePattern));\n  }\n\n  // Filter by viewport\n  if (validatedQuery.viewport) {\n    const viewportPattern = validatedQuery.viewport.toLowerCase();\n    filtered = filtered.filter(s => s.viewport.name.toLowerCase() === viewportPattern);\n  }\n\n  // Filter by date range\n  if (validatedQuery.createdAfter) {\n    const afterTime = validatedQuery.createdAfter.getTime();\n    filtered = filtered.filter(s => new Date(s.createdAt).getTime() >= afterTime);\n  }\n\n  if (validatedQuery.createdBefore) {\n    const beforeTime = validatedQuery.createdBefore.getTime();\n    filtered = filtered.filter(s => new Date(s.createdAt).getTime() <= beforeTime);\n  }\n\n  // Apply limit\n  return filtered.slice(0, validatedQuery.limit);\n}\n\n/**\n * Get timeline of sessions for a specific route/URL\n * Returns sessions in chronological order (oldest first) for tracking changes over time\n */\nexport async function getTimeline(\n  outputDir: string,\n  route: string,\n  limit: number = 10\n): Promise<Session[]> {\n  const sessions = await findSessions(outputDir, { route, limit });\n  // Reverse to get chronological order (oldest first)\n  return sessions.reverse();\n}\n\n/**\n * Get sessions grouped by route\n */\nexport async function getSessionsByRoute(\n  outputDir: string\n): Promise<Record<string, Session[]>> {\n  const allSessions = await listSessions(outputDir);\n  const byRoute: Record<string, Session[]> = {};\n\n  for (const session of allSessions) {\n    let route: string;\n    try {\n      route = new URL(session.url).pathname;\n    } catch {\n      route = session.url;\n    }\n\n    if (!byRoute[route]) {\n      byRoute[route] = [];\n    }\n    byRoute[route].push(session);\n  }\n\n  return byRoute;\n}\n\n/**\n * Get session statistics\n */\nexport async function getSessionStats(outputDir: string): Promise<{\n  total: number;\n  byStatus: Record<string, number>;\n  byViewport: Record<string, number>;\n  byVerdict: Record<string, number>;\n}> {\n  const sessions = await listSessions(outputDir);\n\n  const byStatus: Record<string, number> = {};\n  const byViewport: Record<string, number> = {};\n  const byVerdict: Record<string, number> = {};\n\n  for (const session of sessions) {\n    // Count by status\n    byStatus[session.status] = (byStatus[session.status] || 0) + 1;\n\n    // Count by viewport\n    const viewportName = session.viewport.name;\n    byViewport[viewportName] = (byViewport[viewportName] || 0) + 1;\n\n    // Count by verdict\n    if (session.analysis?.verdict) {\n      byVerdict[session.analysis.verdict] = (byVerdict[session.analysis.verdict] || 0) + 1;\n    }\n  }\n\n  return {\n    total: sessions.length,\n    byStatus,\n    byViewport,\n    byVerdict,\n  };\n}\n","import type { Session, ComparisonResult, Analysis, ComparisonReport } from './schemas.js';\nimport { getVerdictDescription } from './compare.js';\nimport { getSessionPaths } from './session.js';\n\n/**\n * Generate a full comparison report\n */\nexport function generateReport(\n  session: Session,\n  comparison: ComparisonResult,\n  analysis: Analysis,\n  outputDir: string,\n  webViewPort?: number\n): ComparisonReport {\n  const paths = getSessionPaths(outputDir, session.id);\n\n  const report: ComparisonReport = {\n    sessionId: session.id,\n    sessionName: session.name,\n    url: session.url,\n    timestamp: new Date().toISOString(),\n    viewport: session.viewport,\n    comparison,\n    analysis,\n    files: {\n      baseline: paths.baseline,\n      current: paths.current,\n      diff: paths.diff,\n    },\n  };\n\n  if (webViewPort) {\n    report.webViewUrl = `http://localhost:${webViewPort}/sessions/${session.id}`;\n  }\n\n  return report;\n}\n\n/**\n * Format report as human-readable text\n */\nexport function formatReportText(report: ComparisonReport): string {\n  const lines: string[] = [];\n\n  lines.push(`Session: ${report.sessionName} (${report.sessionId})`);\n  lines.push(`URL: ${report.url}`);\n  lines.push(`Viewport: ${report.viewport.name} (${report.viewport.width}x${report.viewport.height})`);\n  lines.push('');\n  lines.push('Comparison Results:');\n  lines.push(`  Match: ${report.comparison.match ? 'Yes' : 'No'}`);\n  lines.push(`  Diff: ${report.comparison.diffPercent}% (${report.comparison.diffPixels.toLocaleString()} pixels)`);\n  lines.push(`  Threshold: ${report.comparison.threshold}%`);\n  lines.push('');\n  lines.push(`Verdict: ${report.analysis.verdict}`);\n  lines.push(`  ${getVerdictDescription(report.analysis.verdict)}`);\n  lines.push('');\n  lines.push(`Summary: ${report.analysis.summary}`);\n\n  if (report.analysis.recommendation) {\n    lines.push('');\n    lines.push(`Recommendation: ${report.analysis.recommendation}`);\n  }\n\n  if (report.analysis.unexpectedChanges.length > 0) {\n    lines.push('');\n    lines.push('Unexpected Changes:');\n    for (const change of report.analysis.unexpectedChanges) {\n      lines.push(`  - ${change.location}: ${change.description}`);\n    }\n  }\n\n  lines.push('');\n  lines.push('Files:');\n  lines.push(`  Baseline: ${report.files.baseline}`);\n  lines.push(`  Current: ${report.files.current}`);\n  lines.push(`  Diff: ${report.files.diff}`);\n\n  if (report.webViewUrl) {\n    lines.push('');\n    lines.push(`View in browser: ${report.webViewUrl}`);\n  }\n\n  return lines.join('\\n');\n}\n\n/**\n * Format report as minimal output (for scripts)\n */\nexport function formatReportMinimal(report: ComparisonReport): string {\n  const status = report.comparison.match ? 'PASS' : 'FAIL';\n  return `${status} ${report.sessionId} ${report.analysis.verdict} ${report.comparison.diffPercent}%`;\n}\n\n/**\n * Format report as JSON\n */\nexport function formatReportJson(report: ComparisonReport): string {\n  return JSON.stringify(report, null, 2);\n}\n\n/**\n * Generate a summary line for session listing\n */\nexport function formatSessionSummary(session: Session): string {\n  const status = session.status.padEnd(8);\n  const viewport = `${session.viewport.name}`.padEnd(8);\n  const date = new Date(session.createdAt).toLocaleDateString();\n\n  let diffInfo = '';\n  if (session.comparison) {\n    diffInfo = session.comparison.match\n      ? ' (no diff)'\n      : ` (${session.comparison.diffPercent}% diff)`;\n  }\n\n  return `${session.id}  ${status}  ${viewport}  ${date}  ${session.name}${diffInfo}`;\n}\n","import { ConfigSchema, VIEWPORTS, type Config, type Session, type SessionQuery, type ComparisonReport } from './schemas.js';\nimport { captureScreenshot, closeBrowser } from './capture.js';\nimport { compareImages, analyzeComparison } from './compare.js';\nimport {\n  createSession,\n  getSession,\n  updateSession,\n  markSessionCompared,\n  listSessions,\n  getMostRecentSession,\n  deleteSession,\n  cleanSessions,\n  getSessionPaths,\n  findSessions,\n  getTimeline,\n  getSessionsByRoute,\n  getSessionStats,\n} from './session.js';\nimport { generateReport } from './report.js';\nimport type { StartSessionOptions, StartSessionResult, CleanOptions } from './types.js';\n\nexport class InterfaceBuiltRight {\n  private config: Config;\n\n  constructor(options: Partial<Config> = {}) {\n    // Validate and merge with defaults\n    this.config = ConfigSchema.parse(options);\n  }\n\n  /**\n   * Start a visual session by capturing a baseline screenshot\n   */\n  async startSession(path: string, options: StartSessionOptions = {}): Promise<StartSessionResult> {\n    const {\n      name = this.generateSessionName(path),\n      viewport = this.config.viewport,\n      fullPage = this.config.fullPage,\n    } = options;\n\n    const url = this.resolveUrl(path);\n\n    // Create session\n    const session = await createSession(this.config.outputDir, url, name, viewport);\n    const paths = getSessionPaths(this.config.outputDir, session.id);\n\n    // Capture baseline (outputDir enables auth state loading)\n    await captureScreenshot({\n      url,\n      outputPath: paths.baseline,\n      viewport,\n      fullPage,\n      waitForNetworkIdle: this.config.waitForNetworkIdle,\n      timeout: this.config.timeout,\n      outputDir: this.config.outputDir,\n    });\n\n    return {\n      sessionId: session.id,\n      baseline: paths.baseline,\n      session,\n    };\n  }\n\n  /**\n   * Check current state against baseline\n   */\n  async check(sessionId?: string): Promise<ComparisonReport> {\n    // Get session\n    const session = sessionId\n      ? await getSession(this.config.outputDir, sessionId)\n      : await getMostRecentSession(this.config.outputDir);\n\n    if (!session) {\n      throw new Error(sessionId\n        ? `Session not found: ${sessionId}`\n        : 'No sessions found. Run startSession first.');\n    }\n\n    const paths = getSessionPaths(this.config.outputDir, session.id);\n\n    // Capture current screenshot (outputDir enables auth state loading)\n    await captureScreenshot({\n      url: session.url,\n      outputPath: paths.current,\n      viewport: session.viewport,\n      fullPage: this.config.fullPage,\n      waitForNetworkIdle: this.config.waitForNetworkIdle,\n      timeout: this.config.timeout,\n      outputDir: this.config.outputDir,\n    });\n\n    // Compare images\n    const comparison = await compareImages({\n      baselinePath: paths.baseline,\n      currentPath: paths.current,\n      diffPath: paths.diff,\n      threshold: this.config.threshold / 100, // Convert percentage to 0-1 range for pixelmatch\n    });\n\n    // Analyze results\n    const analysis = analyzeComparison(comparison, this.config.threshold);\n\n    // Update session\n    await markSessionCompared(this.config.outputDir, session.id, comparison, analysis);\n\n    // Generate report\n    return generateReport(session, comparison, analysis, this.config.outputDir);\n  }\n\n  /**\n   * Get a session by ID\n   */\n  async getSession(sessionId: string): Promise<Session | null> {\n    return getSession(this.config.outputDir, sessionId);\n  }\n\n  /**\n   * Get the most recent session\n   */\n  async getMostRecentSession(): Promise<Session | null> {\n    return getMostRecentSession(this.config.outputDir);\n  }\n\n  /**\n   * List all sessions\n   */\n  async listSessions(): Promise<Session[]> {\n    return listSessions(this.config.outputDir);\n  }\n\n  /**\n   * Delete a session\n   */\n  async deleteSession(sessionId: string): Promise<boolean> {\n    return deleteSession(this.config.outputDir, sessionId);\n  }\n\n  /**\n   * Clean old sessions\n   */\n  async clean(options: CleanOptions = {}): Promise<{ deleted: string[]; kept: string[] }> {\n    return cleanSessions(this.config.outputDir, options);\n  }\n\n  /**\n   * Find sessions matching query criteria\n   */\n  async find(query: Partial<SessionQuery> = {}): Promise<Session[]> {\n    return findSessions(this.config.outputDir, query);\n  }\n\n  /**\n   * Get timeline of sessions for a specific route\n   * Returns sessions in chronological order (oldest first)\n   */\n  async getTimeline(route: string, limit: number = 10): Promise<Session[]> {\n    return getTimeline(this.config.outputDir, route, limit);\n  }\n\n  /**\n   * Get sessions grouped by route\n   */\n  async getSessionsByRoute(): Promise<Record<string, Session[]>> {\n    return getSessionsByRoute(this.config.outputDir);\n  }\n\n  /**\n   * Get session statistics\n   */\n  async getStats(): Promise<{\n    total: number;\n    byStatus: Record<string, number>;\n    byViewport: Record<string, number>;\n    byVerdict: Record<string, number>;\n  }> {\n    return getSessionStats(this.config.outputDir);\n  }\n\n  /**\n   * Update baseline with current screenshot\n   */\n  async updateBaseline(sessionId?: string): Promise<Session> {\n    const session = sessionId\n      ? await getSession(this.config.outputDir, sessionId)\n      : await getMostRecentSession(this.config.outputDir);\n\n    if (!session) {\n      throw new Error(sessionId\n        ? `Session not found: ${sessionId}`\n        : 'No sessions found.');\n    }\n\n    const paths = getSessionPaths(this.config.outputDir, session.id);\n\n    // Capture new baseline (outputDir enables auth state loading)\n    await captureScreenshot({\n      url: session.url,\n      outputPath: paths.baseline,\n      viewport: session.viewport,\n      fullPage: this.config.fullPage,\n      waitForNetworkIdle: this.config.waitForNetworkIdle,\n      timeout: this.config.timeout,\n      outputDir: this.config.outputDir,\n    });\n\n    // Reset session status\n    return updateSession(this.config.outputDir, session.id, {\n      status: 'baseline',\n      comparison: undefined,\n      analysis: undefined,\n    });\n  }\n\n  /**\n   * Close the browser instance\n   */\n  async close(): Promise<void> {\n    await closeBrowser();\n  }\n\n  /**\n   * Get configuration\n   */\n  getConfig(): Config {\n    return { ...this.config };\n  }\n\n  /**\n   * Resolve a path to full URL\n   */\n  private resolveUrl(path: string): string {\n    if (path.startsWith('http://') || path.startsWith('https://')) {\n      return path;\n    }\n    return `${this.config.baseUrl}${path.startsWith('/') ? path : `/${path}`}`;\n  }\n\n  /**\n   * Generate a session name from path\n   */\n  private generateSessionName(path: string): string {\n    // Remove leading slash and replace remaining slashes with dashes\n    return path\n      .replace(/^\\/+/, '')\n      .replace(/\\//g, '-')\n      .replace(/[^a-zA-Z0-9-_]/g, '')\n      || 'homepage';\n  }\n}\n\n// Export everything for programmatic use\nexport * from './schemas.js';\nexport * from './types.js';\nexport { captureScreenshot, closeBrowser, getViewport } from './capture.js';\nexport { compareImages, analyzeComparison, getVerdictDescription } from './compare.js';\nexport {\n  createSession,\n  getSession,\n  updateSession,\n  markSessionCompared,\n  listSessions,\n  getMostRecentSession,\n  deleteSession,\n  cleanSessions,\n  getSessionPaths,\n  generateSessionId,\n  findSessions,\n  getTimeline,\n  getSessionsByRoute,\n  getSessionStats,\n} from './session.js';\nexport { generateReport, formatReportText, formatReportJson, formatReportMinimal, formatSessionSummary } from './report.js';\nexport { VIEWPORTS };\n"]}